<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø«Ù„Ø«Ø§Øª: Ø£Ø­Ù…Ø± ÙˆØ£Ø³ÙˆØ¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion, increment, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ============================================================
        // ğŸ”´ Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹: Ø¶Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù‡Ù†Ø§ Ù„ÙŠØ¹Ù…Ù„ Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ğŸ”´
        // ============================================================
        
        const myFirebaseConfig = {
            // Ø§Ø³ØªØ¨Ø¯Ù„ "YOUR_API_KEY" ÙˆØ§Ù„Ù…ÙØªØ§Ø­ Ø¨Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ ÙŠØ¹Ø·ÙŠÙƒ Ø¥ÙŠØ§Ù‡ ÙØ§ÙŠØ±Ø¨ÙŠØ³
              apiKey: "AIzaSyDy3Dh9YOEM9oYy-YhwJuuhqD-RjBXeDUY",
  authDomain: "gen-lang-client-0822914632.firebaseapp.com",
  projectId: "gen-lang-client-0822914632",
  storageBucket: "gen-lang-client-0822914632.firebasestorage.app",
  messagingSenderId: "142184267758",
  appId: "1:142184267758:web:1059ed83d44cc460a0d8ff",
  measurementId: "G-33984TXCE5"
        };

        // ============================================================

        // Variables specific to this module scope
        let db, auth, user;
        let gameUnsubscribe = null;
        let onlineGameId = null;
        let myOnlineRole = null; 

        // Firebase Configuration Logic
        let firebaseConfig = null;
        
        // 1. Try environment config (Preview Mode)
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } 
        // 2. Try user provided config (Deployment Mode)
        else if (myFirebaseConfig.apiKey !== "YOUR_API_KEY") {
            firebaseConfig = myFirebaseConfig;
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'triangle-game-v1';

        async function initFirebase() {
            if (!firebaseConfig) {
                console.warn("Firebase config missing.");
                const statusEl = document.getElementById('online-status');
                if(statusEl) {
                    statusEl.innerHTML = "âš ï¸ <span style='color:red'>Ù„Ù… ØªØ¶Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ÙÙŠ Ø§Ù„ÙƒÙˆØ¯!</span>";
                    statusEl.style.color = "orange";
                }
                // Unlock buttons just to show the alert when clicked
                document.getElementById('online-menu-btns').classList.remove('opacity-50', 'pointer-events-none');
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) {
                        console.log("Firebase Connected. User:", user.uid);
                        const statusEl = document.getElementById('online-status');
                        const btnsEl = document.getElementById('online-menu-btns');
                        if(statusEl) {
                            statusEl.innerText = "Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… âœ…";
                            statusEl.style.color = "green";
                        }
                        if(btnsEl) btnsEl.classList.remove('opacity-50', 'pointer-events-none');
                    }
                });

            } catch (error) {
                console.error("Firebase Init Error:", error);
                const statusEl = document.getElementById('online-status');
                if(statusEl) {
                    statusEl.innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ âŒ";
                    statusEl.style.color = "red";
                }
                if (error.code === 'auth/operation-not-allowed') {
                    alert("ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…: ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ Ø®ÙŠØ§Ø± 'Anonymous' ÙÙŠ Ù‚Ø³Ù… Authentication Ø¯Ø§Ø®Ù„ Ù…ÙˆÙ‚Ø¹ Firebase.");
                }
            }
        }

        // Initialize immediately
        initFirebase();

        // --- Online Functions ---

        window.createGame = async function() {
            if (!firebaseConfig) return alert("Ø¹ÙÙˆØ§Ù‹! Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.\nØ±Ø§Ø¬Ø¹ Ø§Ù„Ø³Ø·ÙˆØ± Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙŠ Ù…Ù„Ù index.html ÙˆØ§Ø³ØªØ¨Ø¯Ù„ YOUR_API_KEY Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ.");
            if (!user) return alert("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…... ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase");
            
            try {
                const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
                const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', roomId);
                
                await setDoc(gameRef, {
                    lines: [],
                    triangles: [],
                    scores: { red: 0, black: 0 },
                    currentPlayer: 'red',
                    status: 'waiting', 
                    hostId: user.uid,
                    createdAt: new Date().toISOString()
                });

                enterOnlineMode(roomId, 'red');
                document.getElementById('room-code-display').innerText = roomId;
                document.getElementById('waiting-msg').classList.remove('hidden');
                
                copyToClipboard(roomId);
                alert(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©! Ø§Ù„Ø±Ù…Ø² Ù‡Ùˆ: ${roomId}\n(ØªÙ… Ø§Ù„Ù†Ø³Ø®)`);
                
            } catch (e) {
                console.error("Create Game Error:", e);
                if (e.code === 'permission-denied') {
                    alert("Ø®Ø·Ø£ ØµÙ„Ø§Ø­ÙŠØ§Øª: ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firestore Rules ÙÙŠ Firebase Ù„ØªÙƒÙˆÙ† (allow read, write: if true)");
                } else {
                    alert("ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©: " + e.message);
                }
            }
        }

        window.joinGame = async function() {
            if (!firebaseConfig) return alert("Ø¹ÙÙˆØ§Ù‹! Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ÙÙŠ Ø§Ù„ÙƒÙˆØ¯.");
            if (!user) return alert("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…...");
            const roomId = prompt("Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©:");
            if (!roomId) return;

            try {
                const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', roomId);
                const docSnap = await getDoc(gameRef);

                if (docSnap.exists()) {
                    await updateDoc(gameRef, {
                        status: 'playing',
                        guestId: user.uid
                    });
                    enterOnlineMode(roomId, 'black');
                } else {
                    alert("Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!");
                }
            } catch (e) {
                console.error("Join Game Error:", e);
                alert("ÙØ´Ù„ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…: " + e.message);
            }
        }

        function enterOnlineMode(roomId, role) {
            onlineGameId = roomId;
            myOnlineRole = role;
            window.isOnline = true;
            window.isAIEnabled = false; 
            
            document.getElementById('lobby-overlay').classList.add('hidden');
            document.getElementById('game-info-bar').classList.remove('hidden');
            document.getElementById('room-id-span').innerText = roomId;
            document.getElementById('my-role-span').innerText = role === 'red' ? "Ø£Ù†Øª: Ø§Ù„Ø£Ø­Ù…Ø± ğŸ”´" : "Ø£Ù†Øª: Ø§Ù„Ø£Ø³ÙˆØ¯ âš«";
            document.getElementById('ai-toggle-container').classList.add('hidden'); 
            
            const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', roomId);
            if (gameUnsubscribe) gameUnsubscribe();
            
            gameUnsubscribe = onSnapshot(gameRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.lines = data.lines || [];
                    window.triangles = data.triangles || [];
                    window.scores = data.scores || { red: 0, black: 0 };
                    window.currentPlayer = data.currentPlayer;
                    
                    if (data.status === 'playing') {
                        document.getElementById('waiting-msg').classList.add('hidden');
                    }

                    window.updateUI();
                    window.draw();
                } else {
                    alert("ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ø§Ù„ØºØ±ÙØ© Ù‚Ø¯ Ø£ØºÙ„Ù‚Øª.");
                    window.resetGame();
                }
            }, (error) => {
                console.error("Snapshot Error:", error);
            });
        }

        window.sendMoveToFirebase = async function(newLine, newTriangles, nextPlayer, newScores) {
            if (!onlineGameId || !user) return;
            try {
                const gameRef = doc(db, 'artifacts', appId, 'public', 'data', 'games', onlineGameId);
                await updateDoc(gameRef, {
                    lines: window.lines,
                    triangles: window.triangles,
                    currentPlayer: nextPlayer,
                    scores: newScores
                });
            } catch (e) {
                console.error("Sync Error:", e);
            }
        }
        
        // Robust Copy Function
        function copyToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                prompt("Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ù…Ø² ÙŠØ¯ÙˆÙŠØ§Ù‹:", text);
            }
            document.body.removeChild(textArea);
        }
    </script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            touch-action: none;
            user-select: none;
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        .player-indicator { transition: all 0.3s ease; }
        .active-p1 { transform: scale(1.05); box-shadow: 0 0 15px currentColor; opacity: 1 !important; }
        .active-p2 { transform: scale(1.05); box-shadow: 0 0 15px currentColor; opacity: 1 !important; }
        .sage-bubble {
            position: relative; background: #f0fdf4; border: 2px solid #22c55e;
            border-radius: 15px; padding: 15px; margin-top: 10px;
        }
        .sage-bubble::after {
            content: ''; position: absolute; top: -10px; right: 20px;
            border-width: 0 10px 10px; border-style: solid; border-color: #22c55e transparent;
            display: block; width: 0;
        }
        .thinking-dots:after { content: '.'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }
        .loader {
            border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3498db;
            width: 20px; height: 20px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .dare-box { background: repeating-linear-gradient(45deg, #fff, #fff 10px, #fdf2f8 10px, #fdf2f8 20px); }
        .lore-text {
            font-size: 0.8rem;
            color: currentColor;
            opacity: 0.8;
            margin-bottom: 0.5rem;
            font-style: italic;
        }
    </style>
</head>
<body id="main-body" class="bg-gray-100 min-h-screen flex flex-col items-center justify-center overflow-y-auto py-4 transition-colors duration-500 text-gray-800">

    <!-- Header & Score -->
    <div class="w-full max-w-md px-4 mb-2">
        <div class="flex justify-between items-center mb-2 relative">
             <div class="flex-1 text-center">
                 <h1 id="game-title" class="text-2xl font-bold">Ø­Ø±Ø¨ Ø§Ù„Ù…Ø«Ù„Ø«Ø§Øª</h1>
                 <p id="game-lore" class="lore-text hidden">...</p>
             </div>
             <button onclick="toggleDarkMode()" class="absolute left-0 top-1 bg-gray-200 dark:bg-gray-700 p-2 rounded-full hover:bg-gray-300 transition shadow-sm" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">
                <span id="dark-mode-icon">ğŸŒ™</span>
             </button>
        </div>
        
        <!-- Online & AI Toggles -->
        <div class="flex justify-center gap-4 mb-3 items-center">
            <button onclick="showLobby()" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 px-4 rounded-full shadow transition flex items-center gap-2">
                <span>ğŸŒ</span> Ù„Ø¹Ø¨ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†
            </button>

            <div id="ai-toggle-container">
                 <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="ai-toggle" class="sr-only peer">
                    <div class="relative w-11 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                    <span id="ai-label" class="ms-2 text-xs font-bold text-gray-600">Ø¶Ø¯ AI</span>
                </label>
            </div>
            
            <button onclick="toggleSound()" id="sound-btn" class="text-gray-600 hover:text-blue-600">
                <svg id="sound-icon-on" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                <svg id="sound-icon-off" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path></svg>
            </button>
        </div>
        
        <!-- Online Info Bar -->
        <div id="game-info-bar" class="hidden flex justify-between items-center bg-blue-100 p-2 rounded-lg mb-2 text-xs text-blue-800 border border-blue-200">
            <span id="my-role-span" class="font-bold"></span>
            <div>
                ØºØ±ÙØ©: <span id="room-id-span" class="font-mono bg-white px-1 rounded"></span>
            </div>
            <span id="waiting-msg" class="animate-pulse text-orange-600 font-bold">Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø®ØµÙ…...</span>
        </div>

        <!-- THEME INPUT -->
        <div class="flex gap-2 mb-4 bg-white p-2 rounded-lg shadow-sm border border-gray-200" id="theme-box">
            <input type="text" id="theme-input" placeholder="Ø§ÙƒØªØ¨ Ø«ÙŠÙ…Ø§Ù‹ (Ù…Ø«Ù„Ø§Ù‹: ÙØ¶Ø§Ø¡ØŒ ØºØ§Ø¨Ø©)..." class="flex-1 text-sm p-2 border border-gray-300 rounded focus:outline-none focus:border-blue-500 text-right text-gray-800">
            <button onclick="generateTheme()" id="theme-btn" class="bg-gradient-to-r from-pink-500 to-orange-400 text-white text-xs font-bold px-3 rounded hover:opacity-90 transition flex items-center gap-1">
                <span>ğŸ¨</span> <span id="theme-btn-text">ØªÙ„ÙˆÙŠÙ† ÙˆÙ‚ØµØ©</span>
            </button>
        </div>

        <div id="scoreboard" class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-lg border border-gray-200 transition-colors duration-500 text-gray-800">
            <div id="p1-panel" class="player-indicator flex flex-col items-center justify-center w-1/3 p-2 rounded-xl border border-transparent transition-colors duration-300">
                <span class="font-bold text-lg">Ø£Ù†Øª (Ø£Ø­Ù…Ø±)</span>
                <span id="score-red" class="text-3xl font-bold">0</span>
            </div>
            <div class="flex flex-col items-center w-1/3">
                <span id="turn-text" class="text-sm mb-1 opacity-70">Ø§Ù„Ø¯ÙˆØ±</span>
                <div id="turn-indicator" class="w-8 h-8 rounded-full shadow-md transition-colors duration-300"></div>
            </div>
            <div id="p2-panel" class="player-indicator flex flex-col items-center justify-center w-1/3 p-2 rounded-xl border border-transparent transition-colors duration-300">
                <span id="black-name" class="font-bold text-lg">Ø§Ù„Ø®ØµÙ…</span>
                <span id="score-black" class="text-3xl font-bold">0</span>
            </div>
        </div>
    </div>

    <!-- Game Canvas -->
    <div id="canvas-container" class="relative bg-white rounded-xl shadow-xl p-2 border border-gray-200 mt-2 transition-colors duration-500">
        <canvas id="gameCanvas"></canvas>
        
        <!-- Winner Overlay -->
        <div id="winner-overlay" class="hidden absolute inset-0 bg-white/95 z-10 flex flex-col items-center justify-center rounded-xl backdrop-blur-sm transition-all duration-500 p-4 text-center overflow-y-auto">
            <h2 id="winner-text" class="text-4xl font-bold mb-2 text-gray-800">ÙØ§Ø² Ø§Ù„Ø£Ø­Ù…Ø±!</h2>
            
            <!-- Winner's Wish Section -->
            <div class="w-full max-w-xs mb-4 dare-box p-4 rounded-lg border-2 border-pink-200 shadow-inner">
                <h3 class="text-sm font-bold text-pink-600 mb-2">ğŸ‘‘ Ø£Ù…Ø± Ø§Ù„ÙØ§Ø¦Ø²</h3>
                <input type="text" id="wish-topic" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ø­ÙƒÙ…..." class="w-full text-sm p-2 mb-2 border border-pink-300 rounded focus:outline-none focus:border-pink-500 text-right text-gray-800 bg-white/80">
                <p id="wish-text" class="text-gray-700 text-lg font-bold min-h-[3rem] flex items-center justify-center mb-2">Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± ğŸ‘‡</p>
                <button onclick="generateWish()" id="wish-btn" class="w-full text-sm bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white font-bold py-2 px-4 rounded-full shadow transition transform active:scale-95">âš–ï¸ Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø­ÙƒÙ…</button>
            </div>

            <!-- Epic Poem Section -->
            <div id="recap-container" class="w-full max-w-xs mb-4 hidden">
                <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200 text-sm text-yellow-900 italic font-serif">
                    <p id="recap-text">...</p>
                </div>
            </div>

            <div class="flex flex-col gap-2 w-full max-w-xs">
                <button onclick="generateRecap()" id="recap-btn" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-6 rounded-full shadow-lg transform transition hover:scale-105 active:scale-95">
                    ğŸ“œ Ù‚ØµÙŠØ¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙƒØ©
                </button>
                <button onclick="resetGame()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:scale-105 active:scale-95 w-full">Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            </div>
        </div>
    </div>

    <!-- ONLINE LOBBY MODAL -->
    <div id="lobby-overlay" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center relative">
            <button onclick="closeLobby()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">âœ•</button>
            <h2 class="text-2xl font-bold mb-4 text-blue-600">Ù„Ø¹Ø¨ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ğŸŒ</h2>
            <p id="online-status" class="text-xs text-gray-500 mb-6">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</p>
            
            <div id="online-menu-btns" class="space-y-4 opacity-50 pointer-events-none transition-opacity">
                <button onclick="createGame()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg transform active:scale-95 transition">
                    Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
                </button>
                
                <div class="flex items-center gap-2">
                    <div class="h-px bg-gray-300 flex-1"></div>
                    <span class="text-gray-400 text-xs">Ø£Ùˆ</span>
                    <div class="h-px bg-gray-300 flex-1"></div>
                </div>

                <button onclick="joinGame()" class="w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 rounded-xl shadow-lg transform active:scale-95 transition">
                    Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© (Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²)
                </button>
            </div>
            
            <div id="room-code-display" class="mt-4 text-3xl font-mono font-bold text-gray-800 tracking-widest select-all"></div>
        </div>
    </div>

    <!-- AI Sage Section -->
    <div class="w-full max-w-md px-4 mt-4">
        <button onclick="consultSage('commentary')" id="sage-btn" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white font-bold py-2 px-4 rounded-xl shadow-md transition transform active:scale-95 flex items-center justify-center gap-2">
            <span class="text-xl">ğŸ§™â€â™‚ï¸</span> Ø§Ø³ØªØ´Ø± Ø§Ù„Ø­ÙƒÙŠÙ… Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ
        </button>
        <div id="sage-response-area" class="hidden mt-2">
            <div class="sage-bubble shadow-sm" id="sage-bubble-el">
                <div class="flex items-start gap-3">
                    <div class="bg-purple-100 p-2 rounded-full min-w-[40px] text-center text-xl">ğŸ’¬</div>
                    <div>
                        <p class="font-bold text-gray-800 text-sm mb-1">Ø§Ù„Ø­ÙƒÙŠÙ… ÙŠÙ‚ÙˆÙ„:</p>
                        <p id="sage-text" class="text-gray-700 text-sm leading-relaxed">...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="mt-6 flex gap-4 mb-8">
        <button onclick="undoMove()" id="undo-btn" class="flex items-center gap-2 text-gray-700 bg-white hover:bg-yellow-50 py-2 px-6 rounded-lg shadow border border-gray-200 transition disabled:opacity-50 disabled:cursor-not-allowed">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg> ØªØ±Ø§Ø¬Ø¹
        </button>
        <button onclick="resetGame()" class="flex items-center gap-2 text-red-600 bg-white hover:bg-red-50 py-2 px-6 rounded-lg shadow border border-gray-200 transition">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/></svg> Ø¥Ø¹Ø§Ø¯Ø©
        </button>
    </div>
    
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreRedEl = document.getElementById('score-red');
        const scoreBlackEl = document.getElementById('score-black');
        const p1Panel = document.getElementById('p1-panel');
        const p2Panel = document.getElementById('p2-panel');
        const turnIndicator = document.getElementById('turn-indicator');
        const winnerOverlay = document.getElementById('winner-overlay');
        const winnerText = document.getElementById('winner-text');
        const aiToggle = document.getElementById('ai-toggle');
        const undoBtn = document.getElementById('undo-btn');
        const blackNameEl = document.getElementById('black-name');
        const wishText = document.getElementById('wish-text');
        const wishBtn = document.getElementById('wish-btn');
        const wishTopicInput = document.getElementById('wish-topic');
        
        const mainBody = document.getElementById('main-body');
        const canvasContainer = document.getElementById('canvas-container');
        const scoreboard = document.getElementById('scoreboard');
        const gameTitle = document.getElementById('game-title');
        const gameLore = document.getElementById('game-lore');
        const aiLabel = document.getElementById('ai-label');
        const themeBtn = document.getElementById('theme-btn');
        const themeInput = document.getElementById('theme-input');
        const themeBtnText = document.getElementById('theme-btn-text');
        const themeBox = document.getElementById('theme-box');
        const sageBtn = document.getElementById('sage-btn');
        const sageResponseArea = document.getElementById('sage-response-area');
        const sageText = document.getElementById('sage-text');
        const sageBubble = document.getElementById('sage-bubble-el');
        const recapBtn = document.getElementById('recap-btn');
        const recapContainer = document.getElementById('recap-container');
        const recapText = document.getElementById('recap-text');
        
        const apiKey = "AIzaSyB3NC7YCpb9XqlflOFWDglSzDHIwF-36dU"; 
        let audioCtx = null;
        let soundEnabled = true;

        const DOT_RADIUS = 7;
        const CLICK_TOLERANCE = 25;
        let GRID_SIZE = 50; 
        
        // --- SPACE THEME (DEFAULT) ---
        const lightTheme = {
            p1: '#0ea5e9', // Sky Blue
            p2: '#f43f5e', // Rose
            bg: '#0b1120', // Very dark blue (Space background)
            canvasBg: '#1e293b', // Slate 800 (Card background)
            dots: '#94a3b8', // Slate 400 (Stars)
            text: '#f8fafc' // Slate 50 (Text)
        };
        const darkTheme = { p1: '#ef4444', p2: '#000000', bg: '#111827', canvasBg: '#cbd5e1', dots: '#475569', text: '#f3f4f6' };

        let currentTheme = lightTheme;
        let isDarkMode = false;
        
        // GLOBAL INITIALIZATION WITH SAFETY
        window.dots = window.dots || [];
        window.lines = window.lines || []; 
        window.triangles = window.triangles || []; 
        window.currentPlayer = window.currentPlayer || 'red'; 
        window.scores = window.scores || { red: 0, black: 0 };
        
        let selectedDotIndex = -1;
        let isGameOver = false;
        let historyStack = [];
        let isAITurn = false;

        // UI Handlers
        window.showLobby = function() {
            document.getElementById('lobby-overlay').classList.remove('hidden');
        }
        window.closeLobby = function() {
            document.getElementById('lobby-overlay').classList.add('hidden');
        }

        // --- DARK MODE TOGGLE ---
        window.toggleDarkMode = function() {
            isDarkMode = !isDarkMode;
            if (isDarkMode) {
                applyTheme(darkTheme);
                document.getElementById('dark-mode-icon').innerText = 'â˜€ï¸';
                themeBox.classList.add('opacity-50', 'pointer-events-none'); 
            } else {
                applyTheme(lightTheme);
                document.getElementById('dark-mode-icon').innerText = 'ğŸŒ™';
                themeBox.classList.remove('opacity-50', 'pointer-events-none');
            }
        }

        // --- GEMINI WISH GENERATOR ---
        window.generateWish = async function() {
             if (!apiKey) return wishText.innerText = "API Key missing!";
            const topic = wishTopicInput.value.trim();
            wishBtn.disabled = true;
            wishText.innerHTML = '<span class="thinking-dots">Ø¬Ø§Ø±ÙŠ ØµÙŠØ§ØºØ© Ø§Ù„Ø­ÙƒÙ…</span>';
            let prompt = `Ø¨ØµÙØªÙŠ Ø§Ù„ÙØ§Ø¦Ø²ØŒ Ø£Ø±ÙŠØ¯ Ø­ÙƒÙ…Ø§Ù‹ Ù…Ø¶Ø­ÙƒØ§Ù‹ Ù„Ù„Ø®Ø§Ø³Ø±.`;
            if (topic) prompt += ` Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: "${topic}".`; else prompt += ` Ø§Ø®ØªØ± Ù…ÙˆØ¶ÙˆØ¹Ø§Ù‹ Ù…Ø¶Ø­ÙƒØ§Ù‹.`;
            prompt += ` Ø´Ø±Ø·: Ø¬Ù…Ù„Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ø¨ØµÙŠØºØ© Ø§Ù„Ø£Ù…Ø± Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                wishText.innerText = data.candidates[0].content.parts[0].text;
            } catch (error) { wishText.innerText = "Ø§Ø¨ØªØ³Ù… Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§! ğŸ˜„"; } 
            finally { wishBtn.disabled = false; wishBtn.innerText = "ğŸ”„ Ø­ÙƒÙ… Ø¢Ø®Ø±"; }
        }

        // --- GEMINI THEME & LORE GENERATOR ---
        window.generateTheme = async function() {
            const promptText = themeInput.value.trim();
            if (!promptText) return;
            if (!apiKey) { alert("API Key missing"); return; }
            if (isDarkMode) toggleDarkMode(); 

            themeBtn.disabled = true; themeBtnText.innerText = "";
            const loader = document.createElement('div'); loader.className = "loader"; themeBtn.appendChild(loader);

            const systemPrompt = `
            You are a creative UI theme & story generator. 
            Generate a JSON object with:
            1. Theme colors: bg, canvasBg, p1, p2, dots, text (High contrast).
            2. 'lore': A very short (1 sentence) dramatic Arabic backstory for this battle theme.
            Example: {"bg":"...", ..., "lore": "ÙÙŠ Ø¹Ø§Ù… 3000ØŒ ØªØªØµØ§Ø±Ø¹ Ù‚Ø¨Ø§Ø¦Ù„ Ø§Ù„Ù†ÙŠÙˆÙ† Ù„Ù„Ø³ÙŠØ·Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¬Ø±Ø©."}
            `;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, generationConfig: { responseMimeType: "application/json" } })
                });
                const data = await response.json();
                const newTheme = JSON.parse(data.candidates[0].content.parts[0].text);
                applyTheme(newTheme);
                if (newTheme.lore) {
                    gameLore.innerText = newTheme.lore;
                    gameLore.classList.remove('hidden');
                }
            } catch (e) { console.error(e); } 
            finally { themeBtn.removeChild(loader); themeBtnText.innerText = "ØªÙ„ÙˆÙŠÙ† ÙˆÙ‚ØµØ©"; themeBtn.disabled = false; }
        }

        function applyTheme(theme) {
            currentTheme = theme;
            mainBody.style.backgroundColor = theme.bg; mainBody.style.color = theme.text;
            gameTitle.style.color = theme.text; aiLabel.style.color = theme.text;
            scoreboard.style.backgroundColor = theme.canvasBg; scoreboard.style.color = theme.text;
            canvasContainer.style.backgroundColor = theme.canvasBg; canvas.style.backgroundColor = theme.canvasBg;
            window.draw(); window.updateUI();
        }

        // --- GEMINI EPIC RECAP ---
        window.generateRecap = async function() {
            if (!apiKey) return;
            recapBtn.disabled = true;
            recapContainer.classList.remove('hidden');
            recapText.innerHTML = '<span class="thinking-dots">Ø¬Ø§Ø±ÙŠ Ù†Ø¸Ù… Ø§Ù„Ù‚ØµÙŠØ¯Ø©</span>';

            const winner = window.scores.red > window.scores.black ? "Ø§Ù„Ø£Ø­Ù…Ø±" : "Ø§Ù„Ø£Ø³ÙˆØ¯";
            const loreContext = gameLore.innerText || "Ø­Ø±Ø¨ Ø§Ù„Ù…Ø«Ù„Ø«Ø§Øª";
            
            const prompt = `
            Ø§ÙƒØªØ¨ Ù‚ØµÙŠØ¯Ø© Ù…Ù„Ø­Ù…ÙŠØ© Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ (Ø£Ø±Ø¨Ø¹Ø© Ø£Ø³Ø·Ø± ÙÙ‚Ø·) Ø£Ùˆ Ù‚ØµØ© Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ Ø¨Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ø­ÙƒÙˆØ§ØªÙŠØŒ ØªØµÙ Ù…Ø¹Ø±ÙƒØ© Ø§Ù†ØªÙ‡Øª Ø¨ÙÙˆØ² ${winner} Ø¨Ù†ØªÙŠØ¬Ø© ${window.scores.red} Ù…Ù‚Ø§Ø¨Ù„ ${window.scores.black}.
            Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø¹Ø±ÙƒØ© (Ø§Ù„Ø«ÙŠÙ…): ${loreContext}.
            Ø§Ø¬Ø¹Ù„Ù‡Ø§ Ù…Ø¶Ø­ÙƒØ© Ø£Ùˆ Ø¯Ø±Ø§Ù…ÙŠØ© Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø§Ù„Øº ÙÙŠÙ‡.
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                recapText.innerText = data.candidates[0].content.parts[0].text;
            } catch (error) { recapText.innerText = "ØªØ¹Ø°Ø± Ø§Ø³ØªØ­Ø¶Ø§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®..."; } 
            finally { recapBtn.classList.add('hidden'); }
        }

        // --- GEMINI SAGE ---
        window.consultSage = async function(mode) {
            if (!apiKey) return;
            sageResponseArea.classList.remove('hidden');
            sageText.innerHTML = '<span class="thinking-dots">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±</span>';
            sageBtn.disabled = true; sageBtn.classList.add('opacity-50');
            sageBubble.style.borderColor = currentTheme.p1;
            sageBubble.style.background = isDarkMode ? '#1f2937' : '#f0fdf4';
            sageText.style.color = isDarkMode ? '#f3f4f6' : '#374151';

            let prompt = mode === 'victory' ? 
                `Ø£Ù†Øª Ù…Ø¹Ù„Ù‚ Ø­ÙƒÙŠÙ…. ÙØ§Ø² ${window.scores.red > window.scores.black ? "Ø§Ù„Ø£Ø­Ù…Ø±" : "Ø§Ù„Ø£Ø³ÙˆØ¯"}. Ø¹Ù„Ù‘Ù‚ Ø¨Ø§Ø®ØªØµØ§Ø± Ø´Ø¯ÙŠØ¯ ÙˆÙ…Ø¶Ø­Ùƒ.` : 
                `Ø£Ù†Øª Ù…Ø¹Ù„Ù‚. Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ø£Ø­Ù…Ø±=${window.scores.red}, Ø£Ø³ÙˆØ¯=${window.scores.black}. Ø§Ù„Ø¯ÙˆØ± Ù„Ù€: ${window.currentPlayer}. Ø¹Ù„Ù‘Ù‚ Ø¨Ø¬Ù…Ù„Ø© ÙˆØ§Ø­Ø¯Ø© Ù…Ø¶Ø­ÙƒØ©.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                sageText.innerText = data.candidates[0].content.parts[0].text;
            } catch (error) { sageText.innerText = "ğŸ˜´"; } 
            finally { sageBtn.disabled = false; sageBtn.classList.remove('opacity-50'); }
        }

        // --- CORE GAME ---
        function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        function playTone(freq, type, duration) {
            if (!soundEnabled || !audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }
        function playSound(action) {
            initAudio();
            if (action === 'select') playTone(400, 'sine', 0.1);
            if (action === 'connect') playTone(600, 'triangle', 0.1);
            if (action === 'score') { playTone(800, 'sine', 0.1); setTimeout(() => playTone(1200, 'square', 0.2), 100); }
            if (action === 'win') { playTone(500, 'sine', 0.2); }
        }
        window.toggleSound = function() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-icon-on').classList.toggle('hidden');
            document.getElementById('sound-icon-off').classList.toggle('hidden');
        }

        function resizeCanvas() {
            const containerWidth = Math.min(window.innerWidth - 32, 500); 
            const containerHeight = containerWidth; 
            canvas.width = containerWidth; canvas.height = containerHeight;
            GRID_SIZE = containerWidth / 7; 
            initDots();
            window.draw();
        }

        function initDots() {
            window.dots = [];
            const rows = 6;
            for (let r = 0; r < rows; r++) {
                const y = 50 + r * (GRID_SIZE * 0.866);
                const xOffset = (r % 2) * (GRID_SIZE / 2);
                for (let c = 0; c < 5; c++) {
                   if(r === 0 && c === 4 || r === 0 && c === 0 || r === 5 && c === 0 || r === 5 && c === 4) continue;
                   const x = 50 + c * GRID_SIZE + xOffset + (canvas.width - (5 * GRID_SIZE))/2 - 25; 
                   window.dots.push({ x, y, id: window.dots.length });
                }
            }
        }

        function saveState() {
            const state = {
                lines: JSON.parse(JSON.stringify(window.lines || [])),
                triangles: JSON.parse(JSON.stringify(window.triangles || [])),
                currentPlayer: window.currentPlayer,
                scores: { ...window.scores }
            };
            historyStack.push(state);
            if (historyStack.length > 50) historyStack.shift();
            undoBtn.disabled = false;
        }

        window.undoMove = function() {
            if (historyStack.length === 0 || isGameOver || isAITurn || window.isOnline) return; // Disable undo online
            const state = historyStack.pop();
            window.lines = state.lines; window.triangles = state.triangles;
            window.currentPlayer = state.currentPlayer; window.scores = state.scores;
            selectedDotIndex = -1; isGameOver = false;
            winnerOverlay.classList.add('hidden');
            undoBtn.disabled = historyStack.length === 0;
            window.updateUI(); window.draw();
        }

        window.resetGame = function() {
            if (window.isOnline && confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„.")) {
                 window.location.reload(); // Hard reset for online
                 return;
            }
            window.lines = []; window.triangles = []; historyStack = [];
            window.currentPlayer = 'red'; selectedDotIndex = -1;
            window.scores = { red: 0, black: 0 }; isGameOver = false; isAITurn = false;
            window.isAIEnabled = aiToggle.checked; window.isOnline = false;
            
            blackNameEl.innerText = window.isAIEnabled ? "Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±" : "Ø§Ù„Ø®ØµÙ…";
            document.getElementById('game-info-bar').classList.add('hidden');
            document.getElementById('ai-toggle-container').classList.remove('hidden');
            
            winnerOverlay.classList.add('hidden'); sageResponseArea.classList.add('hidden');
            recapContainer.classList.add('hidden'); recapBtn.classList.remove('hidden'); recapBtn.disabled = false; recapText.innerText = "...";
            wishTopicInput.value = ""; wishText.innerText = "Ø§ÙƒØªØ¨ Ù†ÙˆØ¹ Ø§Ù„Ø­ÙƒÙ… ÙˆØ§Ø¶ØºØ· Ø§Ù„Ø²Ø± ğŸ‘‡";
            wishBtn.disabled = false;
            
            initDots(); window.updateUI(); undoBtn.disabled = true; window.draw();
        }

        function addLine(idx1, idx2) {
            const lines = window.lines || [];
            const p1 = Math.min(idx1, idx2); const p2 = Math.max(idx1, idx2);
            if (lines.some(l => (l.p1 === p1 && l.p2 === p2))) return false;
            const d1 = window.dots[p1], d2 = window.dots[p2];
            if (Math.hypot(d1.x - d2.x, d1.y - d2.y) > GRID_SIZE * 1.3) return false;

            if (!window.isOnline) saveState();
            
            // Optimistic update
            window.lines.push({ p1, p2, color: window.currentPlayer });
            playSound('connect');
            
            const madeTriangle = checkForTriangles(p1, p2);
            let nextPlayer = window.currentPlayer;
            
            if (madeTriangle) {
                playSound('score');
            } else {
                nextPlayer = window.currentPlayer === 'red' ? 'black' : 'red';
            }

            // Sync if Online
            if (window.isOnline) {
                window.sendMoveToFirebase(window.lines, window.triangles, nextPlayer, window.scores);
            } else {
                window.currentPlayer = nextPlayer;
            }

            selectedDotIndex = -1;
            window.updateUI();
            window.draw();
            
            // AI Logic (Offline Only)
            if (!window.isOnline && window.isAIEnabled && window.currentPlayer === 'black' && !isGameOver) {
                isAITurn = true;
                setTimeout(aiMove, 600);
            }
            return true;
        }

        function aiMove() {
            if (isGameOver || window.currentPlayer !== 'black') { isAITurn = false; return; }

            let bestMove = null;
            let validMoves = [];
            for (let i = 0; i < window.dots.length; i++) {
                for (let j = i + 1; j < window.dots.length; j++) {
                    const dist = Math.hypot(window.dots[i].x - window.dots[j].x, window.dots[i].y - window.dots[j].y);
                    if (dist < GRID_SIZE * 1.3 && !window.lines.some(l => l.p1 === i && l.p2 === j)) {
                         validMoves.push({p1: i, p2: j});
                    }
                }
            }
            if (validMoves.length === 0) return;

            // Try to score
            for (let move of validMoves) {
                for (let k = 0; k < window.dots.length; k++) {
                    if (k === move.p1 || k === move.p2) continue;
                    const l1 = window.lines.some(l => (l.p1 === Math.min(move.p1, k) && l.p2 === Math.max(move.p1, k)));
                    const l2 = window.lines.some(l => (l.p1 === Math.min(move.p2, k) && l.p2 === Math.max(move.p2, k)));
                    if (l1 && l2) { bestMove = move; break; }
                }
                if (bestMove) break;
            }

            if (!bestMove) bestMove = validMoves[Math.floor(Math.random() * validMoves.length)];
            addLine(bestMove.p1, bestMove.p2);
        }

        function checkForTriangles(newP1, newP2) {
            let found = false;
            for (let k = 0; k < window.dots.length; k++) {
                if (k === newP1 || k === newP2) continue;
                const hasLine1 = window.lines.some(l => (l.p1 === Math.min(newP1, k) && l.p2 === Math.max(newP1, k)));
                const hasLine2 = window.lines.some(l => (l.p1 === Math.min(newP2, k) && l.p2 === Math.max(newP2, k)));

                if (hasLine1 && hasLine2) {
                    const p1 = Math.min(newP1, newP2, k);
                    const p3 = Math.max(newP1, newP2, k);
                    const p2 = (newP1 + newP2 + k) - p1 - p3;
                    if (!window.triangles.some(t => t.p1 === p1 && t.p2 === p2 && t.p3 === p3)) {
                        window.triangles.push({ p1, p2, p3, color: window.currentPlayer });
                        window.scores[window.currentPlayer]++;
                        found = true;
                    }
                }
            }
            return found;
        }

        window.updateUI = function() {
            // FIX: Add safety check for undefined scores
            if (!window.scores) {
                window.scores = { red: 0, black: 0 };
            }

            if (scoreRedEl) scoreRedEl.innerText = window.scores.red;
            if (scoreBlackEl) scoreBlackEl.innerText = window.scores.black;

            p1Panel.style.borderColor = window.currentPlayer === 'red' ? currentTheme.p1 : 'transparent';
            p2Panel.style.borderColor = window.currentPlayer === 'black' ? currentTheme.p2 : 'transparent';
            
            if (window.currentPlayer === 'red') {
                p1Panel.classList.add('active-p1'); p1Panel.classList.remove('opacity-50');
                p2Panel.classList.remove('active-p2'); p2Panel.classList.add('opacity-50');
                p1Panel.style.color = currentTheme.p1; turnIndicator.style.backgroundColor = currentTheme.p1;
            } else {
                p2Panel.classList.add('active-p2'); p2Panel.classList.remove('opacity-50');
                p1Panel.classList.remove('active-p1'); p1Panel.classList.add('opacity-50');
                p2Panel.style.color = currentTheme.p2; turnIndicator.style.backgroundColor = currentTheme.p2;
            }
        }

        window.draw = function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // FIX: Re-initialize if undefined
            if (!window.triangles) window.triangles = [];
            if (!window.lines) window.lines = [];
            if (!window.dots) window.dots = [];

            window.triangles.forEach(t => {
                const d1 = window.dots[t.p1], d2 = window.dots[t.p2], d3 = window.dots[t.p3];
                // Extra safety
                if (!d1 || !d2 || !d3) return;

                ctx.beginPath(); ctx.moveTo(d1.x, d1.y); ctx.lineTo(d2.x, d2.y); ctx.lineTo(d3.x, d3.y); ctx.closePath();
                const baseColor = t.color === 'red' ? currentTheme.p1 : currentTheme.p2;
                ctx.fillStyle = baseColor; ctx.globalAlpha = 0.4; ctx.fill();
                ctx.globalAlpha = 1.0; ctx.strokeStyle = baseColor; ctx.lineWidth = 1; ctx.stroke();
            });
            ctx.lineWidth = 4; ctx.lineCap = 'round';
            window.lines.forEach(l => {
                const d1 = window.dots[l.p1], d2 = window.dots[l.p2];
                if (!d1 || !d2) return;

                ctx.beginPath(); ctx.moveTo(d1.x, d1.y); ctx.lineTo(d2.x, d2.y);
                ctx.strokeStyle = l.color === 'red' ? currentTheme.p1 : currentTheme.p2; ctx.stroke();
            });
            window.dots.forEach((dot, index) => {
                ctx.beginPath(); ctx.arc(dot.x, dot.y, DOT_RADIUS, 0, Math.PI * 2);
                if (index === selectedDotIndex) {
                    ctx.fillStyle = window.currentPlayer === 'red' ? currentTheme.p1 : currentTheme.p2;
                    ctx.shadowColor = window.currentPlayer === 'red' ? currentTheme.p1 : currentTheme.p2; ctx.shadowBlur = 15;
                } else { ctx.fillStyle = currentTheme.dots; ctx.shadowBlur = 0; }
                ctx.fill(); ctx.shadowBlur = 0;
            });
        }

        function handleInput(e) {
            // Online Check: If online, only allow input if it's my turn
            if (window.isOnline && myOnlineRole !== window.currentPlayer) return;

            if (isGameOver || (window.isAIEnabled && window.currentPlayer === 'black')) return;
            const rect = canvas.getBoundingClientRect();
            let clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            let clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            const x = clientX - rect.left; const y = clientY - rect.top;
            
            let clickedDotIndex = -1;
            for (let i = 0; i < window.dots.length; i++) {
                if (Math.hypot(x - window.dots[i].x, y - window.dots[i].y) < CLICK_TOLERANCE) { clickedDotIndex = i; break; }
            }

            if (clickedDotIndex !== -1) {
                if (selectedDotIndex === -1) {
                    selectedDotIndex = clickedDotIndex; playSound('select');
                } else if (selectedDotIndex === clickedDotIndex) {
                    selectedDotIndex = -1;
                } else {
                    const success = addLine(selectedDotIndex, clickedDotIndex);
                    if (!success) {
                        if (Math.hypot(window.dots[selectedDotIndex].x - window.dots[clickedDotIndex].x, window.dots[selectedDotIndex].y - window.dots[clickedDotIndex].y) > GRID_SIZE * 1.5) {
                            selectedDotIndex = clickedDotIndex; playSound('select');
                        }
                    }
                }
                window.draw();
            } else {
                selectedDotIndex = -1; window.draw();
            }
        }

        canvas.addEventListener('mousedown', handleInput);
        canvas.addEventListener('touchstart', handleInput, {passive: false});
        aiToggle.addEventListener('change', window.resetGame);
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas(); 
        
        // APPLY DEFAULT THEME AT START
        applyTheme(lightTheme);
        window.updateUI();
    </script>
</body>
</html>
